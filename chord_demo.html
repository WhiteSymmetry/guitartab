<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/raphael/1.5.2/raphael-min.js"></script>
    <script>


        function demo() {
            var paper = Raphael(50, 50, 1000, 1000);

            var x = 20
            var y = 50
            var string_spacing = 20
            var fret_spacing = 25
            var fret_count = 5
            var string_count = 6
            var chord_name = "C"
            var tuning = ["E", "A", "D", "G", "B", "E"];
            var left_fingering = [-1, 3, 2, 0, 1, 0]
            var chord_bars = 1 //bar
            var bar_width = 400
            var tab_spacing = 10
            var bar_seq = 1


            // Draw strings
            for (var i = 0; i < string_count; ++i) {
                paper.path("M" + (x + string_spacing * i) + " " + y + "L" + (x + string_spacing * i) + " " + (y + fret_spacing * fret_count - fret_spacing / 2))
            }

            // Draw frets
            for (var i = 0; i < fret_count; ++i) {
                paper.path("M" + x + " " + (y + fret_spacing * i) + "L" + (x + string_spacing * (string_count - 1)) + " " + (y + fret_spacing * i))
            }

            // Draw tuning keys
            for (var i = 0; i < string_count; ++i) {
                var t = paper.text(x + string_spacing * i, y + fret_count * fret_spacing, tuning[i]);
            }

            // Draw chord name
            var t = paper.text(x + string_spacing * (string_count - 1) / 2, y - fret_spacing, chord_name)
            t.attr("font-size", 20)

            // Draw finger
            for (var i = 0; i < left_fingering.length; i++) {
                var p = left_fingering[i]
                if (p == -1) {
                    paper.text(x + string_spacing * i, y - fret_spacing / 4, "x")
                }
                if (p == 0) {
                    paper.text(x + string_spacing * i, y - fret_spacing / 4, "o")
                }
                if (p > 0) {
                    paper.circle(x + string_spacing * i, y + fret_spacing * p - fret_spacing / 2, string_spacing / 3).attr("fill", "black")
                }
            }

            // Draw tab
            for (var i = 0; i < 6; i++) {
                paper.path("M" +
                            x +
                            " " +
                            (y + fret_spacing * (fret_count + 1) + tab_spacing * i) +
                            "L" +
                            (x + chord_bars * bar_width) +
                            " " +
                            (y + fret_spacing * (fret_count + 1)  + tab_spacing * i)
                )
            }

            // Draw bar
            paper.path("M" +
                        (x + chord_bars * bar_width) +
                        " " +
                        (y + fret_spacing * (fret_count + 1)) +
                        "L" +
                        ((x + chord_bars * bar_width)) +
                        " " +
                        (y + fret_spacing * (fret_count + 1) + tab_spacing * 5)
            )

            if (bar_seq % 4 == 1) {
                paper.path("M" +
                        x +
                        " " +
                        (y + fret_spacing * (fret_count + 1)) +
                        "L" +
                        x +
                        " " +
                        (y + fret_spacing * (fret_count + 1) + tab_spacing * 5)
                )
                paper.text(x + tab_spacing / 2, y + fret_spacing * (fret_count + 1) + tab_spacing + tab_spacing / 2, "T").attr("font-size", 10)
                paper.text(x + tab_spacing / 2, y + fret_spacing * (fret_count + 1) + tab_spacing * 2 + tab_spacing / 2, "A").attr("font-size", 10)
                paper.text(x + tab_spacing / 2, y + fret_spacing * (fret_count + 1) + tab_spacing * 3 + tab_spacing / 2, "B").attr("font-size", 10)
            }

            //Draw right fingering
            //时值 四分音符 = 1
            //fret -1 表示X
            var right_fingering = [
                {
                    notes: [{string: 5, fret: -1}, {string: 1, fret: -1}],
                    duration: 0.5
                },
                {
                    notes: [{string: 3, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.5
                },
                {
                    notes: [{string: 3, fret: -1}],
                    duration: 0.5
                },
                {
                    notes: [{string: 1, fret: -1}],
                    duration: 0.5
                },
                {
                    notes: [{string: 3, fret: -1}],
                    duration: 0.5
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 3, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 3, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 6, fret: -1}],
                    duration: 0.5
                },
                {
                    notes: [{string: 3, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
                {
                    notes: [{string: 2, fret: -1}],
                    duration: 0.25
                },
            ]

            var total_duration = 0
            var time_signature = "4/4"
            var bar_beats = time_signature.split("/")[0]
//            var bar_time = time_signature.split("/")[1]
            var bars = 0
            var note_spacing = 50

            for (var i = 0; i < right_fingering.length; i++) {

                var rf = right_fingering[i]
                var duration = rf["duration"]
                total_duration += duration

                for (var j = 0; j < rf["notes"].length; j++) {
                    var note = rf["notes"][j]
                    var string_number = note["string"]

                    var note_start_x = x + tab_spacing * 2 + total_duration * note_spacing
                    var note_start_y = y + fret_spacing * (fret_count + 1) + tab_spacing * (string_number - 1)
                    var note_end_y = y + fret_spacing * (fret_count + 1) + tab_spacing * 7

                    var fret = note["fret"]
                    if (fret == -1) fret = "X"
                    paper.text(note_start_x, note_start_y, fret).attr("font-size", 10)

                    paper.path("M" + note_start_x + " " + note_start_y + "V" + note_end_y)
                    paper.path("M" + note_start_x + " " + (note_start_y - tab_spacing/2) + "S" + (note_start_x + duration * note_spacing/2) + " " + (note_start_y - tab_spacing) + " " + (note_start_x + duration * note_spacing) + " " + (note_start_y - tab_spacing/2)).attr("stroke-width", 1.5)

                    if (parseInt(total_duration) == total_duration) {
                        continue
                    }
                    var note_end_x = note_start_x + duration * note_spacing
                    for (var k = 0; k < 1 / (duration * 2); k++) {
                        paper.path("M" + note_start_x + " " + note_end_y + "H" + note_end_x).attr("stroke-width", 2)
                        note_end_y = note_end_y - tab_spacing * 2 / 3
                    }
                }
            }
        }
        $(function () {
            demo()
        });
    </script>
    <title></title>
</head>
<body>

</body>
</html>
